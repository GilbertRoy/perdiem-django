{% extends "base.html" %}
{% load humanize %}
{% load staticfiles %}
{% load thumbnail %}
{% load campaign %}

{% block extrastyle %}
    <link rel="stylesheet" href="{% static "css/artist/countdown.css" %}" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="{% static "css/artist/artist_detail.css" %}" type="text/css" charset="utf-8" />
    <style>
        #progress {
            float: left;
            width: {% firstof campaign.percentage_funded 0 %}%;
            height: 20px;
            background: #3090C7;
            z-index: 333;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Artist Name -->
    <h1 class="header-font">{{ artist.name }}</h1>
    <div class="break">
        <hr>
    </div>
    {% thumbnail artist.photo.img "500" as thumb %}
        <img class="extra-padding" src="{{ thumb.url }}" width="{{ thumb.width }}" height="{{ thumb.height }}" alt="{{ artist.name }}" />
    {% endthumbnail %}
    <!-- Genre -->
    {% with genres=artist.genres.all %}
        <div class="break">
            <hr>
        </div>
        <h4>Genre{{ genres|length|pluralize }}: {{ genres|join:" / " }}</h4>
    {% endwith %}
    <h4>Location: {{ artist.location }}</h4>
    <div class="break">
        <hr>
    </div>
    {% if campaign %}
        <!-- Goal -->
        <h2>GOAL</h2>
        <h4>${{ campaign.amount|intcomma }} {{ campaign.reason }}</h4>
        <!-- Countdown Widget -->
        <div id="countdown-wrap">
            <div id="glass">
                <div id="progress"></div>
            </div>
            <div id="countdown-stats">
                <div class="goal-stat">
                    <span class="goal-number">{{ campaign.percentage_funded }}%</span>
                    <span class="goal-label">Funded</span>
                </div>
                <div class="goal-stat">
                    <span class="goal-number">${{ campaign.amount_raised|intcomma }}</span>
                    <span class="goal-label">Raised</span>
                </div>
                <div class="goal-stat">
                    <span class="goal-number">{{ campaign.days_remaining }}</span>
                    <span class="goal-label">Days Remaining</span>
                </div>
                <div class="goal-stat">
                    {% with num_investors=investors|length %}
                        <span class="goal-number">{{ num_investors }}</span>
                        <span class="goal-label">Investor{{ num_investors|pluralize }}</span>
                    {% endwith %}
                </div>
            </div>
        </div>
        {% if campaign.days_remaining == 0 %}
            <p><em>Campaign ended {{ campaign.end_datetime|date:'m/d' }}</em></p>
        {% endif %}
        {% if campaign.generated_revenue %}
            <p>${{ campaign.generated_revenue|floatformat:0|intcomma }} generated so far from this campaign (${{ campaign.generated_revenue_fans|floatformat:0|intcomma }} for fans).</p>
        {% endif %}
        <!-- Countdown Widget -->
        </ul>
        <!-- Buy Shares -->
        {% if campaign.open %}
            <div class="break">
                <hr>
            </div>
            <h2>Buy Shares</h2>
            {% if request.user.is_authenticated %}
                <div class="invest-num-shares">
                    <button id="remove-shares" class="secondary hollow button disabled" type="button" disabled>-</button>
                    <input type="number" min="1" max="{{ campaign.num_shares_remaining }}" value="1" />
                    <button id="add-shares" class="secondary hollow button" type="button">+</button>
                </div>
                <button id="invest-button" class="button" type="button">Buy 1 Share</button>
                <br /><small>* = ${{ campaign.value_per_share }} per share + ${{ PERDIEM_FEE }} PerDiem fee + 2.9%+$0.30 credit card fee</small>
            {% else %}
                <p><a data-open="login-modal">Login</a> to invest in {{ artist.name }}.</p>
            {% endif %}
        {% endif %}
    {% endif %}
        <br />
        <br />
    {% if artist.bio %}
        <div class="break">
            <hr>
        </div>
        <!-- Artist Bio -->
        <h2>OUR STORY</h2>
        {{ artist.bio.bio|safe }}
    {% endif %}

    {% if artist.soundcloudplaylist_set.exists %}
        <div class="break">
            <hr>
        </div>
        <!-- Music -->
        <h2>MUSIC</h2>
        <div class="extra-padding">
            {% for playlist in artist.soundcloudplaylist_set.all %}
                <iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url={{ playlist.playlist }}&color=ff5500"></iframe>
            {% endfor %}
        </div>
    {% endif %}

    {% if campaign %}
        <div class="break">
            <hr>
        </div>
        <!-- What is the money being used for? -->
        <h3>WHAT IS THE MONEY BEING USED FOR?</h3>
        <p>{{ campaign.use_of_funds }}</p>
        <ul>
            {% for expense in campaign.expense_set.all %}
                <li>{{ expense.expense }}</li>
            {% endfor %}
            <li><strong>Total = ${{ campaign.amount|intcomma }}</strong></li>
        </ul>
        <div class="break">
            <hr>
        </div>
        <!-- What do you get for investing? -->
        <h3>WHAT DO YOU GET FOR INVESTING?</h3>
        <p>We are raising ${{ campaign.amount|intcomma }} {{ campaign.reason }} and giving {{ campaign.fans_percentage }}% of the sales back to the people who invest in it.</p>
        <div class="break">
            <hr>
        </div>
        <!-- Percentage -->
        <h2>PERCENTAGE</h2>
        <div id="canvas-holder">
            <canvas id="chart-area" width="500" height="500"></canvas>
        </div>
        <ul>
            <li>{{ artist.name }}: {{ campaign.artist_percentage|floatformat:2 }}%</li>
            <li>
                {% if user_investor %}Other Investors:{% else %}Investors:{% endif %}
                {{ fans_percentage|floatformat:2 }}%
            </li>
            {% if user_investor %}
                <li>Me: {{ user_investor.percentage|floatformat:2 }}%</li>
            {% endif %}
        </ul>
        <p>To raise the funds we are selling <strong>{{ campaign.num_shares|intcomma }}</strong> shares at <strong>${{ campaign.value_per_share }}</strong> per share.</p>
        <div class="break">
            <hr>
        </div>
        <!-- Return on Investment -->
        <h2>RETURN ON INVESTMENT</h2>
        <div class="canvas-profile">
            <canvas id="canvas"></canvas>
        </div>
        <div class="profile-padding">
            <p>For example: If this project earns ${{ campaign|percentage_roi:200|intcomma }} in revenue, every investor will 2x their investment.</p>
        </div>
    {% endif %}

    {% if artist.social_set.exists %}
        <div class="break">
            <hr>
        </div>
        <!-- Socials -->
        <h2>FOLLOW US!</h2>
        <ul>
            {% for social in artist.social_set.all %}
                <li><a href="{{ social.url }}">{{ social.get_medium_display }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if investors %}
        <div class="break">
            <hr>
        </div>
        <!-- Current Investors -->
        <ul class="vertical menu" data-accordion-menu>
            <li>
                <a href="#"><h2>CURRENT INVESTORS</h2></a>
                <ul class="menu vertical nested is-active">
                    {% for investor in investors %}
                        <li id="investor-block">
                            {% if investor.public_profile_url %}
                                <a href="{{ investor.public_profile_url }}">
                                    <img class="profile-crop" src="{{ investor.avatar_url }}" alt="{{ investor.name }}" />
                                    {{ investor.name }}
                                </a>
                            {% else %}
                                {{ investor.name }}
                            {% endif %}
                            ${{ investor.total_investment }}
                        </li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    {% endif %}

    {% if updates %}
        <div class="break">
            <hr>
        </div>
        <!-- Updates -->
        <ul class="vertical menu" data-accordion-menu>
            <li>
                <a href= "#"><h2>UPDATES</h2></a>
                <ul class="menu vertical nested is-active">
                    {% for update in updates %}
                        <li>{{ update.created_datetime }}: {{ update.text }}</li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    {% endif %}

    <div class="break">
        <hr>
    </div>
{% endblock %}

{% block extrajs %}
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script type="text/javascript" src="{% static "js/Chart.js" %}"></script>
    <script type="text/javascript">
        var perdiem_fee = {{ PERDIEM_FEE }};
        var artist_name = '{{ artist.name|escapejs }}';

        {% if campaign %}
            var doughnutData = [
                    {% if user_investor %}
                        {
                            value: {{ user_investor.percentage|floatformat:2 }},
                            color: "#000",
                            highlight: "#444",
                            label: "Me"
                        },
                    {% endif %}
                    {
                        value: {{ fans_percentage|floatformat:2 }},
                        color: "#46BFBD",
                        highlight: "#5AD3D1",
                        label: "{% if user_investor %}Other Investors{% else %}Investors{% endif %}"
                    },
                    {
                        value: {{ campaign.artist_percentage|floatformat:2 }},
                        color:"#F7464A",
                        highlight: "#FF5A5E",
                        label: "{{ artist.name|escapejs }}"
                    }

                ];

            var lineChartData = {
                labels : [".5x","1x","2x","5x","10x"],
                datasets : [
                    {
                        label: "Artist Revenue",
                        fillColor : "rgba(220,220,220,0.2)",
                        strokeColor : "rgba(220,220,220,1)",
                        pointColor : "rgba(220,220,220,1)",
                        pointStrokeColor : "#fff",
                        pointHighlightFill : "#fff",
                        pointHighlightStroke : "rgba(220,220,220,1)",
                        data : [{{ campaign|percentage_roi:50 }},{{ campaign|percentage_roi:100 }},{{ campaign|percentage_roi:200 }},{{ campaign|percentage_roi:500 }},{{ campaign|percentage_roi:1000 }}]
                    },
                ]

            }

            window.onload = function(){
                var ctxchart = document.getElementById("chart-area").getContext("2d");
                window.myDoughnut = new Chart(ctxchart).Doughnut(doughnutData, {
                    responsive: true,
                    tooltipTemplate: "<%= label %>: <%= value %>%"
                });
                var ctxline = document.getElementById("canvas").getContext("2d");
                window.myLine = new Chart(ctxline).Line(lineChartData, {
                    responsive: true
                });
            }

            var share_value_cents = {{ campaign.value_per_share_cents|escapejs }};
            var num_shares_remaining = {{ campaign.num_shares_remaining }};
            var stripe_handler = StripeCheckout.configure({
                key: '{{ PINAX_STRIPE_PUBLIC_KEY }}',
                locale: 'auto',
                email: '{{ request.user.email|escapejs }}',
                token: function(token) {
                    var num_shares = parseInt($('.invest-num-shares > input').val());
                    $.post("{% url 'pinax_stripe_charge' campaign_id=campaign.id %}", {card: token.id, num_shares: num_shares})
                        .done(function(resp) {
                            // Show success
                            var success_message = 'Thanks! Your investment is being processed. When payment completes, your name will appear in the investor list.';
                            $('#success-modal > p.success-message').text(success_message);
                            $('#success-modal').foundation('open');
                        })
                        .fail(function(resp) {
                            // Show error
                            var error_message = 'There was an issue processing your payment.<br />' + resp.responseText;
                            $('#error-modal > p.error-message').html(error_message);
                            $('#error-modal').foundation('open');
                        });
                }
            });
        {% endif %}
    </script>
    <script type="text/javascript" src="{% static "js/artist/artist-detail.js" %}"></script>
{% endblock %}
